#SHAPE KEY TRANSFER SCRIPT

import bpy

# –£–∫–∞–∂–∏ –∏–º–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–æ–≤
SOURCE_NAME = "Genesis 8 Female Mesh"  # SOURCE MESH ( for example female mesh )
TARGET_NAME = "Suit Mesh"  # TARGET MESH ( for example clothes )


KEY_WORDS=['PBM']# —É–∫–∞–∂–∏—Ç–µ, –ø–æ –∫–∞–∫–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–µ—Ä–µ–Ω–æ—Å –¥—Ä–∞–π–≤–µ—Ä–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏–ø–∏—Å–∫–∞ facs, PBM, eCTRL

# –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã
source = bpy.data.objects.get(SOURCE_NAME)
target = bpy.data.objects.get(TARGET_NAME)


def Anim_update(): #Updating shape transformations
    for obj in bpy.data.objects:
        if obj.animation_data and obj.animation_data.drivers:
            for fcurve in obj.animation_data.drivers:
                fcurve.update()

def Basis_check(MESH):
    
    cloth=MESH
    
    if not cloth.data.shape_keys:
            bpy.ops.object.shape_key_add(from_mix=False)  # —Å–æ–∑–¥–∞—ë—Ç Basis
            cloth.data.shape_keys.key_blocks[0].name = "Basis"

def cleanup(MESH):
    
    mesh=MESH
    #–û–±–Ω—É–ª—è–µ–º —à–µ–π–ø –∫–µ–∏
    for shape in mesh.data.shape_keys.key_blocks:
        
        print(f"- {shape.name}: {shape.value}")
        if type(shape.value)==float:
            shape.value = 0.0
        elif type(shape.value)==int:
            shape.value = 0
        else:
            continue
    
    bpy.context.view_layer.update()
        
    Anim_update()

    print("üéâ Done! All shape keys are set to 0.")

def main(source, target):
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã
    Basis_check(target)
    
    cleanup(source)
    cleanup(target)
    
    
    body = source
    cloth = target

    # –î–æ–±–∞–≤–ª—è–µ–º Surface Deform –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫ –æ–¥–µ–∂–¥–µ
    surf_def = cloth.modifiers.new(name="SurfaceDeform", type='SURFACE_DEFORM')
    surf_def.target = body

    # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º (Bind)
    bpy.context.view_layer.objects.active = cloth
    bpy.ops.object.surfacedeform_bind(modifier=surf_def.name)

    for key in body.data.shape_keys.key_blocks:
        if KEY_WORDS[0]=='None':
            pass
        elif any(p in key.name for p in KEY_WORDS):
            pass
        else:
            continue
        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —à–µ–π–ø‚Äë–∫–µ–π
        key.value = 1.0
        Anim_update()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º Surface Deform –∫–∞–∫ —à–µ–π–ø‚Äë–∫–µ–π –Ω–∞ –æ–¥–µ–∂–¥–µ
        
        bpy.ops.object.select_all(action='DESELECT')
        cloth.select_set(True)
        bpy.context.view_layer.objects.active = cloth

        bpy.ops.object.modifier_apply_as_shapekey(keep_modifier=True ,modifier="SurfaceDeform")
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π —à–µ–π–ø‚Äë–∫–µ–π –æ–¥–µ–∂–¥—ã
        new_key = cloth.data.shape_keys.key_blocks[-1]
        new_key.name = key.name

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
        key.value = 0.0
        Anim_update()
    
    bpy.ops.object.modifier_remove(modifier="SurfaceDeform")
    print("üéâ Script completed! All shape keys transfered.")

main(source,target)
